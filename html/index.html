<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>GEEKROS</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 500px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background-color: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            h1 {
                color: #333;
                text-align: center;
                font-size: 24px;
                margin-bottom: 20px;
            }
            .form-group {
                margin-bottom: 15px;
            }
            label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }
            input[type="text"],
            input[type="password"],
            select {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-sizing: border-box;
            }
            button {
                padding: 12px;
                background-color: #4caf50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
            }
            button:hover {
                background-color: #45a049;
            }
            .btn-scan {
                background-color: #2196f3;
                margin-bottom: 15px;
            }
            .btn-scan:hover {
                background-color: #0b7dda;
            }
            .status {
                margin-top: 20px;
                padding: 10px;
                border-radius: 4px;
                display: none;
            }
            .success {
                background-color: #dff0d8;
                color: #3c763d;
                display: block;
            }
            .error {
                background-color: #f2dede;
                color: #a94442;
                display: block;
            }
            .loading {
                text-align: center;
                display: none;
                margin-top: 20px;
            }
            .spinner {
                border: 4px solid rgba(0, 0, 0, 0.1);
                border-radius: 50%;
                border-top: 4px solid #3498db;
                width: 30px;
                height: 30px;
                animation: spin 1s linear infinite;
                margin: 0 auto 10px;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
            .wifi-list {
                margin-bottom: 20px;
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 10px;
            }
            .wifi-item {
                padding: 8px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
            }
            .wifi-item:hover {
                background-color: #f5f5f5;
            }
            .wifi-item:last-child {
                border-bottom: none;
            }
            .wifi-signal {
                display: inline-block;
                width: 60px;
            }
            .signal-strong {
                color: #4caf50;
            }
            .signal-medium {
                color: #ffc107;
            }
            .signal-weak {
                color: #f44336;
            }
            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ËÆæÂ§áÁΩëÁªúÈÖçÁΩÆ</h1>

            <button id="scan-btn" class="btn-scan">Êâ´ÊèèÈôÑËøëWi-FiÁΩëÁªú</button>

            <div id="wifi-list-container" class="wifi-list hidden">
                <h3>ÂèØÁî®Wi-FiÁΩëÁªú</h3>
                <div id="wifi-list"></div>
            </div>

            <div class="form-group">
                <label for="ssid">Wi-FiÁΩëÁªúÂêçÁß∞ (SSID)</label>
                <input type="text" id="ssid" placeholder="ËØ∑ËæìÂÖ•ÊàñÈÄâÊã©Wi-FiÂêçÁß∞" />
            </div>

            <div class="form-group">
                <label for="password">Wi-FiÂØÜÁ†Å</label>
                <input type="password" id="password" placeholder="ËØ∑ËæìÂÖ•Wi-FiÂØÜÁ†Å" />
            </div>

            <button id="submit-btn" class="btn-submit">ÈÖçÁΩÆÁΩëÁªú</button>

            <div id="status" class="status"></div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p id="loading-text">Ê≠£Âú®ÈÖçÁΩÆÁΩëÁªúÔºåËØ∑Á®çÂÄô...</p>
            </div>
        </div>

        <script>
            var gateway = `ws://${window.location.hostname}/socket`;
            var websocket;
            let scanTimeId;
            console.log("script run");
            window.addEventListener("load", onLoad); //		<--È°µÈù¢Âä†ËΩΩÂÆåÊØï,ÊâßË°åonLoad-->

            function onLoad(event) {
                initWebSocket();
            }

            function initWebSocket() {
                console.log("Trying to open a WebSocket connection...");
                websocket = new WebSocket(gateway);
                websocket.onopen = onOpen;
                websocket.onclose = onClose;
                websocket.onmessage = onMessage; // <-- add this line
            }

            function onOpen(event) {
                console.log("Connection opened");
            }
            function onClose(event) {
                console.log("Connection closed");
                setTimeout(initWebSocket, 3000);
            }
            function onMessage(event) {
                var state;
                const data = JSON.parse(event.data);
                console.log(event.data);
                const wifiListContainer = document.getElementById("wifi-list-container");
                const wifiList = document.getElementById("wifi-list");
                const btn = document.getElementById("scan-btn");
                clearTimeout(scanTimeId);
                document.getElementById("scan-btn").textContent = "ÈáçÊñ∞Êâ´ÊèèWi-FiÁΩëÁªú";
                wifiListContainer.classList.remove("hidden");
                for (let i = 0; i < data.wifi_list.length; i++) {
                    console.log(`ssid: ${data.wifi_list[i].ssid}, rssi: ${data.wifi_list[i].rssi},encrypted: ${data.wifi_list[i].encrypted}`);

                    const item = document.createElement("div");
                    item.className = "wifi-item";
                    item.innerHTML = `
					<div>
						<strong>${data.wifi_list[i].ssid}</strong>
						<span class="wifi-signal ${getSignalStrengthClass(data.wifi_list[i].rssi)}">
							${getSignalStrengthIcon(data.wifi_list[i].rssi)} ${data.wifi_list[i].rssi}dBm
						</span>
						${data.wifi_list[i].encrypted ? "üîí" : "üåê"}
					</div>
				`;

                    item.addEventListener("click", () => {
                        document.getElementById("ssid").value = data.wifi_list[i].ssid;
                        document.getElementById("password").focus();
                    });

                    wifiList.appendChild(item);
                }
                document.getElementById("loading").style.display = "none";
                btn.disabled = false;
                showStatus("Êâ´ÊèèÂÆåÊàê", "success");
            }

            // Êâ´ÊèèWi-FiÁΩëÁªú
            document.getElementById("scan-btn").addEventListener("click", function () {
                const btn = this;
                const wifiListContainer = document.getElementById("wifi-list-container");
                const wifiList = document.getElementById("wifi-list");

                btn.disabled = true;
                btn.textContent = "Ê≠£Âú®Êâ´Êèè...";
                document.getElementById("loading-text").textContent = "Ê≠£Âú®Êâ´ÊèèWi-FiÁΩëÁªú...";
                document.getElementById("loading").style.display = "block";
                wifiList.innerHTML = "";
                scanNetwork("start");
                scanTimeId = setTimeout(() => {
                    btn.textContent = "ÈáçÊñ∞Êâ´ÊèèWi-FiÁΩëÁªú";
                    btn.disabled = false;
                    document.getElementById("loading").style.display = "none";
                    showStatus("Êâ´ÊèèWi-FiÁΩëÁªúÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï", "error");
                }, 20 * 1000);
            });

            // Êèê‰∫§ÁΩëÁªúÈÖçÁΩÆ
            document.getElementById("submit-btn").addEventListener("click", function () {
                const ssid = document.getElementById("ssid").value;
                const password = document.getElementById("password").value;

                if (!ssid) {
                    showStatus("ËØ∑ËæìÂÖ•Wi-FiÁΩëÁªúÂêçÁß∞", "error");
                    return;
                }

                document.getElementById("loading-text").textContent = "Ê≠£Âú®ÈÖçÁΩÆÁΩëÁªúÔºåËØ∑Á®çÂÄô...";
                document.getElementById("loading").style.display = "block";
                this.disabled = true;

                // ËøôÈáåÂ∫îËØ•ÊòØÂÆûÈôÖÁöÑÈÖçÁΩëAPIË∞ÉÁî®
                configureNetwork(ssid, password);
            });

            // Ê®°ÊãüÈÖçÁΩÆÁΩëÁªú
            function configureNetwork(ssid, password) {
                const manualJson = '{"ssid":"' + ssid + '","password":"' + password + '"}';
                websocket.send(manualJson);
                showStatus("ÂºÄÂßãÈÖçÁΩÆÁΩëÁªúÔºÅËØ∑ÁïôÊÑèËÆæÂ§á‰ø°ÊÅØ...", "success");
            }

            // ÂºÄÂßãÊâ´Êèè
            function scanNetwork(msg) {
                const manualJson = '{"scan":"' + msg + '"}';
                websocket.send(manualJson);
                showStatus("ÂºÄÂßãÊâ´Êèè....", "success");
            }

            // ÊòæÁ§∫Áä∂ÊÄÅ‰ø°ÊÅØ
            function showStatus(message, type) {
                const statusElement = document.getElementById("status");
                statusElement.textContent = message;
                statusElement.className = "status " + type;
            }

            // Ëé∑Âèñ‰ø°Âè∑Âº∫Â∫¶ÂõæÊ†á
            function getSignalStrengthIcon(rssi) {
                if (rssi >= -50) return "üì∂"; // Âº∫‰ø°Âè∑
                if (rssi >= -70) return "üì∂"; // ‰∏≠Á≠â‰ø°Âè∑
                return "üì∂"; // Âº±‰ø°Âè∑
            }

            // Ëé∑Âèñ‰ø°Âè∑Âº∫Â∫¶CSSÁ±ª
            function getSignalStrengthClass(rssi) {
                if (rssi >= -50) return "signal-strong";
                if (rssi >= -70) return "signal-medium";
                return "signal-weak";
            }
        </script>
    </body>
</html>
